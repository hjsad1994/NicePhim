# üîå WebSocket Code Examples - Subscribe & Publish

## üì° FRONTEND - Subscribe & Publish

### **1. SUBSCRIBE - Nh·∫≠n messages t·ª´ server**

**File:** `nicephim-frontend/src/components/video/WatchTogetherPlayer.tsx`  
**Location:** Lines 354-368

```typescript
// Subscribe to room messages
try {
  const topic = `/topic/room.${roomId}`;
  console.log('üì® Subscribing to topic:', topic);
  
  const subscription = client.subscribe(topic, (message) => {
    console.log('üì® Received message from room topic:', topic);
    try {
      const data = JSON.parse(message.body);
      console.log('üìã Parsed message data:', data);
      handleRoomMessage(data);
    } catch (error) {
      console.error('‚ùå Error parsing WebSocket message:', error);
    }
  });
  
  console.log('‚úÖ Subscription successful:', subscription.id);
  setRoomSubscription(subscription);
} catch (error) {
  console.error('‚ùå Error subscribing to room topic:', error);
}
```

**Gi·∫£i th√≠ch:**
- `client.subscribe(topic, callback)` - Subscribe to topic
- `topic = "/topic/room.{roomId}"` - Room-specific topic
- `callback(message)` - Function ƒë∆∞·ª£c g·ªçi khi nh·∫≠n message
- `message.body` - JSON string ch·ª©a data
- `JSON.parse()` - Parse th√†nh object
- `handleRoomMessage(data)` - Process message

---

### **2. PUBLISH - G·ª≠i messages ƒë·∫øn server**

#### **A. Publish Chat Message**

**File:** `nicephim-frontend/src/components/video/WatchTogetherPlayer.tsx`  
**Location:** Lines 510-542

```typescript
const sendChat = useCallback((message: string) => {
  console.log('üí¨ sendChat called:', {
    message,
    currentUser,
    roomId,
    connected: isWebSocketConnected(),
    stompClientExists: !!stompClient,
    stompClientConnected: stompClient?.connected
  });

  if (isWebSocketConnected()) {
    const chatMessage = {
      type: 'chat',
      message,
      username: currentUser,
      timestamp: Date.now()
    };
    console.log('üí¨ Sending chat message:', chatMessage);
    console.log('üí¨ Destination:', `/app/room/${roomId}/chat`);

    stompClient.publish({
      destination: `/app/room/${roomId}/chat`,
      body: JSON.stringify(chatMessage)
    });
    
    console.log('üí¨ Chat message sent successfully');
  } else {
    console.error('üí¨ Cannot send chat - WebSocket not connected');
  }
}, [stompClient, isConnected, roomId, currentUser]);
```

**Gi·∫£i th√≠ch:**
- `stompClient.publish({ destination, body })` - Send message
- `destination = "/app/room/{roomId}/chat"` - Target endpoint
- `body = JSON.stringify(object)` - Message payload as JSON string
- Backend nh·∫≠n t·∫°i `@MessageMapping("/room/{roomId}/chat")`

---

#### **B. Publish Join Notification**

**File:** `nicephim-frontend/src/components/video/WatchTogetherPlayer.tsx`  
**Location:** Lines 544-587

```typescript
const sendJoin = useCallback((client: Client) => {
  // Prevent duplicate joins
  if (hasJoinedRoom.current) {
    console.log('üîÑ Already joined room, skipping duplicate join');
    return;
  }

  console.log('üìã Sending join message...');
  console.log('üìã Username:', currentUser);
  console.log('üìã Room ID:', roomId);
  console.log('üìã Client connected:', client.connected);

  if (client.connected) {
    try {
      client.publish({
        destination: `/app/room/${roomId}/join`,
        body: JSON.stringify({
          username: currentUser
        })
      });
      
      hasJoinedRoom.current = true; // Mark as joined
      console.log('‚úÖ Join message sent successfully');
    } catch (error) {
      console.error('‚ùå Error sending join message:', error);
    }
  } else {
    console.error('‚ùå Cannot send join message - client not connected');
  }
}, [roomId, currentUser]);
```

**Gi·∫£i th√≠ch:**
- `client.publish()` - C√≥ th·ªÉ d√πng client tr·ª±c ti·∫øp ho·∫∑c `stompClient.publish()`
- `destination = "/app/room/{roomId}/join"` - Join endpoint
- `body` ch·ªâ ch·ª©a username (minimal payload)
- Backend nh·∫≠n t·∫°i `@MessageMapping("/room/{roomId}/join")`

---

#### **C. Publish Leave Notification**

**File:** `nicephim-frontend/src/components/video/WatchTogetherPlayer.tsx`  
**Location:** Lines 406-417 (in cleanup function)

```typescript
// Cleanup on unmount
return () => {
  console.log('üßπ Cleaning up WebSocket connection...');
  if (client && client.connected) {
    if (roomSubscription) {
      console.log('üîÑ Unsubscribing from room subscription on cleanup');
      roomSubscription.unsubscribe();
      setRoomSubscription(null);
    }

    // Send leave message before disconnecting
    if (isConnected && roomId && currentUser) {
      try {
        client.publish({
          destination: `/app/room/${roomId}/leave`,
          body: JSON.stringify({
            username: currentUser
          })
        });
        console.log('üëã Leave message sent');
      } catch (error) {
        console.error('‚ùå Error sending leave message:', error);
      }
    }

    // Deactivate client
    client.deactivate();
    setStompClient(null);
    setIsConnected(false);
  }
};
```

**Gi·∫£i th√≠ch:**
- Ch·∫°y khi component unmount (user r·ªùi trang)
- `client.publish()` - Send leave notification
- `destination = "/app/room/{roomId}/leave"` - Leave endpoint
- Backend cleanup user tracking, KH√îNG broadcast

---

## üì° BACKEND - MessageMapping & SendTo

### **1. Receive & Broadcast: Chat Handler**

**File:** `nicephim-backend/demo/src/main/java/demo/demo/controller/room/RoomController.java`  
**Location:** Lines 178-189

```java
/**
 * Chat messages
 */
@MessageMapping("/room/{roomId}/chat")
@SendTo("/topic/room.{roomId}")
public Map<String, Object> handleChat(
        @DestinationVariable String roomId,
        Map<String, Object> message) {

    message.put("timestamp", System.currentTimeMillis());
    message.put("type", "chat");
    return message;
}
```

**Gi·∫£i th√≠ch:**
- `@MessageMapping("/room/{roomId}/chat")` - **NH·∫¨N** (subscribe) message t·ª´ client g·ª≠i ƒë·∫øn `/app/room/{roomId}/chat`
- `@SendTo("/topic/room.{roomId}")` - **G·ª¨I** (publish) message ƒë·∫øn all clients subscribe `/topic/room.{roomId}`
- `@DestinationVariable String roomId` - Extract roomId t·ª´ URL
- `return message` - Object n√†y s·∫Ω ƒë∆∞·ª£c broadcast

**Flow:**
```
Client A publish ‚Üí /app/room/123/chat
    ‚Üì
@MessageMapping receives
    ‚Üì
handleChat() adds timestamp & type
    ‚Üì
@SendTo broadcasts ‚Üí /topic/room.123
    ‚Üì
All clients subscribed to /topic/room.123 receive
```

---

### **2. Receive & Broadcast: Join Handler**

**File:** `nicephim-backend/demo/src/main/java/demo/demo/controller/room/RoomController.java`  
**Location:** Lines 195-219

```java
/**
 * User join/leave notifications with duplicate prevention
 */
@MessageMapping("/room/{roomId}/join")
@SendTo("/topic/room.{roomId}")
public Map<String, Object> handleJoin(
        @DestinationVariable String roomId,
        Map<String, Object> message) {

    String username = (String) message.get("username");

    // Use service for user tracking with duplicate prevention
    boolean userAdded = watchRoomService.addUserToRoom(roomId, username);

    // Only send join notification if user was actually added
    if (userAdded) {
        message.put("timestamp", System.currentTimeMillis());
        message.put("type", "user_join");
        return message;
    } else {
        // Return empty message to prevent broadcasting duplicate notification
        Map<String, Object> emptyMessage = new HashMap<>();
        emptyMessage.put("type", "system");
        emptyMessage.put("message", "duplicate_join");
        emptyMessage.put("timestamp", System.currentTimeMillis());
        return emptyMessage;
    }
}
```

**Gi·∫£i th√≠ch:**
- `@MessageMapping("/room/{roomId}/join")` - Nh·∫≠n join message
- `watchRoomService.addUserToRoom()` - Track user, return false if duplicate
- `if (userAdded)` - Ch·ªâ broadcast n·∫øu user m·ªõi
- `else` - Return system message (kh√¥ng broadcast duplicate)
- `@SendTo` - Broadcast result

---

### **3. Receive Only: Leave Handler**

**File:** `nicephim-backend/demo/src/main/java/demo/demo/controller/room/RoomController.java`  
**Location:** Lines 224-232

```java
/**
 * User leave handler for cleanup
 */
@MessageMapping("/room/{roomId}/leave")
public void handleLeave(
        @DestinationVariable String roomId,
        Map<String, Object> message) {

    String username = (String) message.get("username");
    // Use service for user tracking and state saving
    watchRoomService.removeUserFromRoom(roomId, username);
}
```

**Gi·∫£i th√≠ch:**
- `@MessageMapping("/room/{roomId}/leave")` - Nh·∫≠n leave message
- **KH√îNG c√≥ @SendTo** - Kh√¥ng broadcast (silent cleanup)
- `watchRoomService.removeUserFromRoom()` - Remove user, save state
- Return type `void` - Kh√¥ng send response

---

## üìä Summary Table - Subscribe & Publish Locations

### **FRONTEND Subscribe:**

| Code | File | Line | Topic | Purpose |
|------|------|------|-------|---------|
| `client.subscribe("/topic/room.{roomId}", callback)` | WatchTogetherPlayer.tsx | 354-368 | `/topic/room.{roomId}` | Nh·∫≠n t·∫•t c·∫£ messages t·ª´ room |

### **FRONTEND Publish:**

| Code | File | Line | Destination | Purpose |
|------|------|------|-------------|---------|
| `stompClient.publish({ destination: "/app/room/{roomId}/chat", ... })` | WatchTogetherPlayer.tsx | 528-531 | `/app/room/{roomId}/chat` | G·ª≠i chat message |
| `client.publish({ destination: "/app/room/{roomId}/join", ... })` | WatchTogetherPlayer.tsx | 555-561 | `/app/room/{roomId}/join` | G·ª≠i join notification |
| `client.publish({ destination: "/app/room/{roomId}/leave", ... })` | WatchTogetherPlayer.tsx | 410-416 | `/app/room/{roomId}/leave` | G·ª≠i leave notification |

### **BACKEND Receive (MessageMapping):**

| Code | File | Line | Endpoint | Purpose |
|------|------|------|----------|---------|
| `@MessageMapping("/room/{roomId}/chat")` | RoomController.java | 178 | `/app/room/{roomId}/chat` | Nh·∫≠n chat t·ª´ client |
| `@MessageMapping("/room/{roomId}/join")` | RoomController.java | 195 | `/app/room/{roomId}/join` | Nh·∫≠n join t·ª´ client |
| `@MessageMapping("/room/{roomId}/leave")` | RoomController.java | 224 | `/app/room/{roomId}/leave` | Nh·∫≠n leave t·ª´ client |

### **BACKEND Broadcast (SendTo):**

| Code | File | Line | Topic | Purpose |
|------|------|------|-------|---------|
| `@SendTo("/topic/room.{roomId}")` | RoomController.java | 179 | `/topic/room.{roomId}` | Broadcast chat message |
| `@SendTo("/topic/room.{roomId}")` | RoomController.java | 196 | `/topic/room.{roomId}` | Broadcast join notification |
| *(No SendTo)* | RoomController.java | 224 | - | Leave kh√¥ng broadcast |

---

## üéØ Complete Code Flow Examples

### **Example 1: User A sends chat "Hello"**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FRONTEND (User A)                                                 ‚îÇ
‚îÇ WatchTogetherPlayer.tsx:528-531                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ stompClient.publish({                                             ‚îÇ
‚îÇ   destination: "/app/room/123/chat",                              ‚îÇ
‚îÇ   body: JSON.stringify({                                          ‚îÇ
‚îÇ     type: "chat",                                                 ‚îÇ
‚îÇ     message: "Hello",                                             ‚îÇ
‚îÇ     username: "UserA",                                            ‚îÇ
‚îÇ     timestamp: 1729593600000                                      ‚îÇ
‚îÇ   })                                                              ‚îÇ
‚îÇ });                                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì WebSocket
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ BACKEND                                                           ‚îÇ
‚îÇ RoomController.java:178-189                                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ @MessageMapping("/room/{roomId}/chat")  ‚Üê NH·∫¨N T·∫†I ƒê√ÇY          ‚îÇ
‚îÇ @SendTo("/topic/room.{roomId}")         ‚Üê G·ª¨I ƒê·∫æN ƒê√ÇY           ‚îÇ
‚îÇ public Map<String, Object> handleChat(...) {                     ‚îÇ
‚îÇ     message.put("timestamp", currentTimeMillis());               ‚îÇ
‚îÇ     message.put("type", "chat");                                 ‚îÇ
‚îÇ     return message; // ‚Üê Object n√†y ƒë∆∞·ª£c broadcast               ‚îÇ
‚îÇ }                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì Broadcast
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ALL CLIENTS subscribed to /topic/room.123                        ‚îÇ
‚îÇ WatchTogetherPlayer.tsx:354-368                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ client.subscribe("/topic/room.123", (message) => {              ‚îÇ
‚îÇ   const data = JSON.parse(message.body);                        ‚îÇ
‚îÇ   // data = {                                                     ‚îÇ
‚îÇ   //   type: "chat",                                             ‚îÇ
‚îÇ   //   message: "Hello",                                         ‚îÇ
‚îÇ   //   username: "UserA",                                        ‚îÇ
‚îÇ   //   timestamp: 1729593600000                                  ‚îÇ
‚îÇ   // }                                                            ‚îÇ
‚îÇ   handleRoomMessage(data);                                       ‚îÇ
‚îÇ });                                                               ‚îÇ
‚îÇ                                                                   ‚îÇ
‚îÇ handleRoomMessage ‚Üí case 'chat' ‚Üí setChatMessages(...)           ‚îÇ
‚îÇ ‚Üí UI updates: "UserA: Hello"                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### **Example 2: User B joins room**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FRONTEND (User B)                                                 ‚îÇ
‚îÇ WatchTogetherPlayer.tsx:555-561                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ const sendJoin = (client: Client) => {                           ‚îÇ
‚îÇ   client.publish({                                               ‚îÇ
‚îÇ     destination: "/app/room/123/join",                           ‚îÇ
‚îÇ     body: JSON.stringify({                                       ‚îÇ
‚îÇ       username: "UserB"                                          ‚îÇ
‚îÇ     })                                                           ‚îÇ
‚îÇ   });                                                            ‚îÇ
‚îÇ };                                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì WebSocket
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ BACKEND                                                           ‚îÇ
‚îÇ RoomController.java:195-219                                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ @MessageMapping("/room/{roomId}/join")  ‚Üê NH·∫¨N                  ‚îÇ
‚îÇ @SendTo("/topic/room.{roomId}")         ‚Üê BROADCAST              ‚îÇ
‚îÇ public Map<String, Object> handleJoin(...) {                    ‚îÇ
‚îÇ     String username = message.get("username");                  ‚îÇ
‚îÇ     boolean added = watchRoomService.addUserToRoom(roomId, username); ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ     if (added) {                                                ‚îÇ
‚îÇ         message.put("timestamp", currentTimeMillis());          ‚îÇ
‚îÇ         message.put("type", "user_join");                       ‚îÇ
‚îÇ         return message; // ‚Üê Broadcast n√†y                      ‚îÇ
‚îÇ     } else {                                                    ‚îÇ
‚îÇ         return Map.of(                                          ‚îÇ
‚îÇ             "type", "system",                                   ‚îÇ
‚îÇ             "message", "duplicate_join"                         ‚îÇ
‚îÇ         ); // ‚Üê Ho·∫∑c n√†y n·∫øu duplicate                          ‚îÇ
‚îÇ     }                                                           ‚îÇ
‚îÇ }                                                               ‚îÇ
‚îÇ     ‚Üì                                                            ‚îÇ
‚îÇ WatchRoomService.java:389-421                                   ‚îÇ
‚îÇ public boolean addUserToRoom(String roomId, String username) { ‚îÇ
‚îÇ     roomUsers.putIfAbsent(roomId, ConcurrentHashMap.newKeySet()); ‚îÇ
‚îÇ     Set<String> users = roomUsers.get(roomId);                 ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ     if (users.contains(username)) {                            ‚îÇ
‚îÇ         return false; // ‚Üê Already joined                      ‚îÇ
‚îÇ     }                                                           ‚îÇ
‚îÇ     users.add(username);                                        ‚îÇ
‚îÇ     return true; // ‚Üê New user added                           ‚îÇ
‚îÇ }                                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì Broadcast
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ALL CLIENTS (including User A, User B, User C)                   ‚îÇ
‚îÇ WatchTogetherPlayer.tsx:439-551                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ handleRoomMessage(data)                                          ‚îÇ
‚îÇ     ‚Üì                                                             ‚îÇ
‚îÇ case 'user_join':                                                ‚îÇ
‚îÇ     setChatMessages([...prev, {                                  ‚îÇ
‚îÇ         username: 'system',                                      ‚îÇ
‚îÇ         message: 'UserB ƒë√£ tham gia ph√≤ng',                     ‚îÇ
‚îÇ         timestamp: data.timestamp,                               ‚îÇ
‚îÇ         type: 'system'                                           ‚îÇ
‚îÇ     }]);                                                         ‚îÇ
‚îÇ     ‚Üì                                                             ‚îÇ
‚îÇ UI shows: "UserB ƒë√£ tham gia ph√≤ng" (system message)            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### **Example 3: User C leaves room**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FRONTEND (User C)                                                 ‚îÇ
‚îÇ WatchTogetherPlayer.tsx:410-416                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ // Component unmount / user closes tab                           ‚îÇ
‚îÇ return () => {                                                   ‚îÇ
‚îÇ   client.publish({                                               ‚îÇ
‚îÇ     destination: "/app/room/123/leave",                          ‚îÇ
‚îÇ     body: JSON.stringify({                                       ‚îÇ
‚îÇ       username: "UserC"                                          ‚îÇ
‚îÇ     })                                                           ‚îÇ
‚îÇ   });                                                            ‚îÇ
‚îÇ   client.deactivate();                                           ‚îÇ
‚îÇ };                                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì WebSocket
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ BACKEND                                                           ‚îÇ
‚îÇ RoomController.java:224-232                                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ @MessageMapping("/room/{roomId}/leave")  ‚Üê NH·∫¨N                 ‚îÇ
‚îÇ ‚ö†Ô∏è KH√îNG C√ì @SendTo (silent cleanup)                            ‚îÇ
‚îÇ public void handleLeave(...) {                                   ‚îÇ
‚îÇ     String username = message.get("username");                  ‚îÇ
‚îÇ     watchRoomService.removeUserFromRoom(roomId, username);      ‚îÇ
‚îÇ     // ‚Üê Kh√¥ng return, kh√¥ng broadcast                          ‚îÇ
‚îÇ }                                                                ‚îÇ
‚îÇ     ‚Üì                                                             ‚îÇ
‚îÇ WatchRoomService.java:428-465                                    ‚îÇ
‚îÇ public void removeUserFromRoom(String roomId, String username) {‚îÇ
‚îÇ     Set<String> users = roomUsers.get(roomId);                  ‚îÇ
‚îÇ     users.remove(username);                                     ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ     if (users.isEmpty()) {                                      ‚îÇ
‚îÇ         saveRoomStateOnEmpty(roomId);                           ‚îÇ
‚îÇ         roomUsers.remove(roomId);                               ‚îÇ
‚îÇ     }                                                            ‚îÇ
‚îÇ }                                                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì NO BROADCAST
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ OTHER CLIENTS                                                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚ö†Ô∏è Kh√¥ng nh·∫≠n leave notification                                 ‚îÇ
‚îÇ (Silent cleanup - kh√¥ng c√≥ th√¥ng b√°o "UserC ƒë√£ r·ªùi ph√≤ng")      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ Key Differences: Subscribe vs Publish

### **üì• SUBSCRIBE (Nh·∫≠n):**

**Frontend:**
```typescript
client.subscribe("/topic/room.123", (message) => {
  const data = JSON.parse(message.body);
  handleRoomMessage(data);
});
```
- **Passive** - Ch·ªù messages t·ª´ server
- **Callback** - Function ƒë∆∞·ª£c g·ªçi khi c√≥ message m·ªõi
- **Topic pattern** - `/topic/room.{roomId}` (broker prefix)

**Backend:**
```java
@MessageMapping("/room/{roomId}/chat")
public Map<String, Object> handleChat(...) { ... }
```
- **Passive** - Ch·ªù messages t·ª´ client
- **App prefix** - Client send ƒë·∫øn `/app/room/{roomId}/chat`
- **Spring auto-maps** - Method ƒë∆∞·ª£c g·ªçi khi c√≥ message

---

### **üì§ PUBLISH (G·ª≠i):**

**Frontend:**
```typescript
stompClient.publish({
  destination: "/app/room/123/chat",
  body: JSON.stringify({ message: "Hello" })
});
```
- **Active** - Ch·ªß ƒë·ªông g·ª≠i message
- **Destination** - Target endpoint tr√™n server
- **Body** - JSON string payload

**Backend:**
```java
@SendTo("/topic/room.{roomId}")
public Map<String, Object> handleChat(...) {
  return message; // This gets broadcasted
}
```
- **Active** - G·ª≠i message ƒë·∫øn all subscribers
- **Topic** - `/topic/room.{roomId}` (broker)
- **Return value** - Object ƒë∆∞·ª£c serialize v√† broadcast

---

## üí° Analogy:

```
SUBSCRIBE = M·ªü radio ƒë·ªÉ NGHE
PUBLISH  = N√≥i v√†o microphone ƒë·ªÉ G·ª¨I

Frontend subscribe "/topic/room.123" 
  = M·ªü radio nghe k√™nh "room 123"
  
Frontend publish "/app/room/123/chat"
  = N√≥i v√†o mic g·ª≠i ƒë·∫øn "chat c·ªßa room 123"
  
Backend @MessageMapping
  = Server nghe (listen) message t·ª´ client
  
Backend @SendTo
  = Server ph√°t (broadcast) message ƒë·∫øn all clients
```

---

## üìù Quick Reference:

**Frontend Client Code:**
- **Connect:** `new SockJS()` + `new Client()` + `client.activate()`
- **Subscribe:** `client.subscribe(topic, callback)` - Lines 354-368
- **Publish Chat:** `stompClient.publish({ destination: "/app/room/{roomId}/chat", ... })` - Lines 528-531
- **Publish Join:** `client.publish({ destination: "/app/room/{roomId}/join", ... })` - Lines 555-561
- **Publish Leave:** `client.publish({ destination: "/app/room/{roomId}/leave", ... })` - Lines 410-416

**Backend Handler Code:**
- **Receive Chat:** `@MessageMapping("/room/{roomId}/chat")` - Line 178
- **Broadcast Chat:** `@SendTo("/topic/room.{roomId}")` - Line 179
- **Receive Join:** `@MessageMapping("/room/{roomId}/join")` - Line 195
- **Broadcast Join:** `@SendTo("/topic/room.{roomId}")` - Line 196
- **Receive Leave:** `@MessageMapping("/room/{roomId}/leave")` - Line 224
- **No Broadcast:** *(No @SendTo for leave)*

üé¨üí¨‚ú®
