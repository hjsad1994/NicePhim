<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xem Chung - Demo (SSE)</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .video-container { position: relative; background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        video { width: 100%; height: auto; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .room-info { background: #e9ecef; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
        .chat-container { display: flex; gap: 20px; }
        .chat-messages { flex: 1; height: 300px; border: 1px solid #ddd; padding: 10px; overflow-y: auto; background: #f8f9fa; }
        .chat-input { display: flex; gap: 10px; margin-top: 10px; }
        .chat-input input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .status.connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.disconnected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .user-list { width: 200px; border: 1px solid #ddd; padding: 10px; background: #f8f9fa; }
        .quality-selector { margin-left: auto; }
        .quality-selector select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .sync-info { background: #fff3cd; color: #856404; padding: 10px; border-radius: 4px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé¨ Xem Chung - Demo (SSE)</h1>
        
        <div class="room-info">
            <h3>Th√¥ng tin ph√≤ng</h3>
            <p><strong>Room ID:</strong> <span id="roomId">demo-room-123</span></p>
            <p><strong>Video ID:</strong> <span id="videoId">fbac9579-1e0c-4eb5-93be-5b05ff50e593</span></p>
            <p><strong>Tr·∫°ng th√°i:</strong> <span id="connectionStatus" class="status disconnected">Ch∆∞a k·∫øt n·ªëi</span></p>
            <div class="sync-info">
                <strong>Sync:</strong> <span id="syncStatus">Ch∆∞a sync</span>
            </div>
        </div>

        <div class="video-container">
            <video id="videoPlayer" controls playsinline></video>
        </div>

        <div class="controls">
            <button id="playPauseBtn" class="btn btn-primary">‚ñ∂Ô∏è Ph√°t</button>
            <button id="seekBackBtn" class="btn btn-warning">‚è™ -10s</button>
            <button id="seekForwardBtn" class="btn btn-warning">‚è© +10s</button>
            <button id="toggleHostBtn" class="btn btn-success">üéÆ L√†m ch·ªß ph√≤ng</button>
            <button id="fullscreenBtn" class="btn btn-info">‚õ∂ Fullscreen</button>
            <div class="quality-selector">
                <select id="qualitySelect">
                    <option value="-1">T·ª± ƒë·ªông</option>
                </select>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-messages" id="chatMessages"></div>
            <div class="user-list" id="userList">
                <h4>Th√†nh vi√™n</h4>
                <div id="users"></div>
            </div>
        </div>

        <div class="chat-input">
            <input type="text" id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn..." maxlength="500">
            <button id="sendChatBtn" class="btn btn-primary">G·ª≠i</button>
        </div>
    </div>

    <script>
        // Configuration
        const ROOM_ID = 'demo-room-123';
        const VIDEO_ID = 'fbac9579-1e0c-4eb5-93be-5b05ff50e593';
        const HLS_URL = `http://localhost:8080/videos/${VIDEO_ID}/master.m3u8`;
        const SSE_URL = `http://localhost:8080/api/room/${ROOM_ID}/events`;

        // State
        let eventSource = null;
        let hls = null;
        let isHost = false;
        let isConnected = false;
        let currentUser = 'User_' + Math.random().toString(36).substr(2, 9);
        let lastSyncTime = 0;

        // DOM elements
        const video = document.getElementById('videoPlayer');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const seekBackBtn = document.getElementById('seekBackBtn');
        const seekForwardBtn = document.getElementById('seekForwardBtn');
        const toggleHostBtn = document.getElementById('toggleHostBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const qualitySelect = document.getElementById('qualitySelect');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const syncStatus = document.getElementById('syncStatus');
        const users = document.getElementById('users');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeVideo();
            connectSSE();
            setupEventListeners();
        });

        function initializeVideo() {
            if (Hls.isSupported()) {
                hls = new Hls({
                    capLevelToPlayerSize: true,
                    enableWorker: true,
                    lowLatencyMode: false
                });
                hls.loadSource(HLS_URL);
                hls.attachMedia(video);

                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    populateQualityOptions();
                });

                hls.on(Hls.Events.ERROR, function(event, data) {
                    console.error('HLS Error:', data);
                    addChatMessage('system', `L·ªói video: ${data.details}`);
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = HLS_URL;
            }

            // Video event listeners
            video.addEventListener('play', () => {
                if (isHost) {
                    sendControl('play', video.currentTime);
                }
                updatePlayPauseButton();
            });

            video.addEventListener('pause', () => {
                if (isHost) {
                    sendControl('pause', video.currentTime);
                }
                updatePlayPauseButton();
            });

            video.addEventListener('seeked', () => {
                if (isHost) {
                    sendControl('seek', video.currentTime);
                }
            });
        }

        function populateQualityOptions() {
            qualitySelect.innerHTML = '<option value="-1">T·ª± ƒë·ªông</option>';
            if (hls && hls.levels) {
                hls.levels.forEach((level, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${level.height}p (${Math.round(level.bitrate/1000)}kbps)`;
                    qualitySelect.appendChild(option);
                });
            }
        }

        function connectSSE() {
            eventSource = new EventSource(SSE_URL);
            
            eventSource.onopen = function(event) {
                console.log('SSE Connected');
                isConnected = true;
                updateConnectionStatus(true);
                sendJoin();
            };

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleRoomMessage(data);
            };

            eventSource.addEventListener('message', function(event) {
                const data = JSON.parse(event.data);
                handleRoomMessage(data);
            });

            eventSource.addEventListener('state', function(event) {
                const data = JSON.parse(event.data);
                handleRoomState(data);
            });

            eventSource.onerror = function(event) {
                console.error('SSE Error:', event);
                isConnected = false;
                updateConnectionStatus(false);
                // Reconnect after 3 seconds
                setTimeout(() => {
                    if (!isConnected) {
                        connectSSE();
                    }
                }, 3000);
            };
        }

        function handleRoomMessage(data) {
            console.log('Received message:', data);
            
            switch(data.type) {
                case 'control':
                    if (!isHost) {
                        handleControlSync(data);
                    }
                    break;
                case 'chat':
                    addChatMessage(data.username || 'Anonymous', data.message);
                    break;
                case 'user_join':
                    addUser(data.username);
                    addChatMessage('system', `${data.username} ƒë√£ tham gia ph√≤ng`);
                    break;
            }
        }

        function handleRoomState(data) {
            console.log('Received state:', data);
            if (data.type === 'control' && !isHost) {
                handleControlSync(data);
            }
        }

        function handleControlSync(data) {
            const { action, time, timestamp } = data;
            const now = Date.now();
            const drift = (now - timestamp) / 1000; // seconds
            const targetTime = time + drift;
            
            lastSyncTime = now;
            updateSyncStatus(`Sync: ${Math.round(drift * 1000)}ms drift`);

            switch(action) {
                case 'play':
                    if (video.paused) {
                        video.currentTime = targetTime;
                        video.play();
                    }
                    break;
                case 'pause':
                    if (!video.paused) {
                        video.currentTime = targetTime;
                        video.pause();
                    }
                    break;
                case 'seek':
                    video.currentTime = targetTime;
                    break;
            }
        }

        function sendControl(action, time) {
            if (isConnected) {
                fetch(`/api/room/${ROOM_ID}/control`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: action,
                        time: time,
                        username: currentUser
                    })
                }).catch(err => console.error('Error sending control:', err));
            }
        }

        function sendJoin() {
            if (isConnected) {
                fetch(`/api/room/${ROOM_ID}/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: currentUser
                    })
                }).catch(err => console.error('Error joining:', err));
            }
        }

        function sendChat(message) {
            if (isConnected) {
                fetch(`/api/room/${ROOM_ID}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        username: currentUser
                    })
                }).catch(err => console.error('Error sending chat:', err));
            }
        }

        function setupEventListeners() {
            playPauseBtn.addEventListener('click', () => {
                if (video.paused) {
                    video.play();
                } else {
                    video.pause();
                }
            });

            seekBackBtn.addEventListener('click', () => {
                video.currentTime = Math.max(0, video.currentTime - 10);
            });

            seekForwardBtn.addEventListener('click', () => {
                video.currentTime = Math.min(video.duration, video.currentTime + 10);
            });

            toggleHostBtn.addEventListener('click', () => {
                isHost = !isHost;
                updateHostButton();
            });

            fullscreenBtn.addEventListener('click', () => {
                if (video.requestFullscreen) {
                    video.requestFullscreen();
                } else if (video.webkitRequestFullscreen) {
                    video.webkitRequestFullscreen();
                } else if (video.msRequestFullscreen) {
                    video.msRequestFullscreen();
                }
            });

            qualitySelect.addEventListener('change', () => {
                if (hls) {
                    hls.currentLevel = parseInt(qualitySelect.value);
                }
            });

            sendChatBtn.addEventListener('click', () => {
                const message = chatInput.value.trim();
                if (message) {
                    sendChat(message);
                    chatInput.value = '';
                }
            });

            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendChatBtn.click();
                }
            });
        }

        function updatePlayPauseButton() {
            playPauseBtn.textContent = video.paused ? '‚ñ∂Ô∏è Ph√°t' : '‚è∏Ô∏è T·∫°m d·ª´ng';
        }

        function updateHostButton() {
            toggleHostBtn.textContent = isHost ? 'üéÆ ƒêang l√† ch·ªß ph√≤ng' : 'üéÆ L√†m ch·ªß ph√≤ng';
            toggleHostBtn.className = isHost ? 'btn btn-danger' : 'btn btn-success';
        }

        function updateConnectionStatus(connected) {
            if (connected) {
                connectionStatus.textContent = 'ƒê√£ k·∫øt n·ªëi (SSE)';
                connectionStatus.className = 'status connected';
            } else {
                connectionStatus.textContent = 'M·∫•t k·∫øt n·ªëi';
                connectionStatus.className = 'status disconnected';
            }
        }

        function updateSyncStatus(status) {
            syncStatus.textContent = status;
        }

        function addChatMessage(username, message) {
            const messageDiv = document.createElement('div');
            messageDiv.innerHTML = `<strong>${username}:</strong> ${message}`;
            messageDiv.style.marginBottom = '5px';
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addUser(username) {
            const userDiv = document.createElement('div');
            userDiv.textContent = username;
            userDiv.style.padding = '2px 0';
            users.appendChild(userDiv);
        }

        // Initialize UI
        updatePlayPauseButton();
        updateHostButton();
        addUser(currentUser);
    </script>
</body>
</html>



